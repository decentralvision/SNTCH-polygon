"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.isYarn = isYarn;
exports.getInstallCommand = getInstallCommand;
exports.runNodePackageManagerScript = runNodePackageManagerScript;
exports.getNodePackageInfo = getNodePackageInfo;
exports.installDependencies = installDependencies;

var _ora = _interopRequireDefault(require("ora"));

var _chalk = _interopRequireDefault(require("chalk"));

var _path = require("path");

var _fs = require("fs");

var _run = _interopRequireDefault(require("./run"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Returns if the user is using yarn or npm based on the lock file
 */
function isYarn() {
  return (0, _fs.existsSync)((0, _path.join)(process.cwd(), 'yarn.lock'));
}
/**
 * Gets the install command for the package manager being used in the user's project
 */


function getInstallCommand() {
  return isYarn() ? 'yarn add --dev' : 'npm i -D';
}
/**
 * Runs npm or yarn command with args based on the package manager used
 * @param {String[]} commandArgs
 */


function runNodePackageManagerScript(commandArgs = [], {
  stdio
} = {}) {
  const command = isYarn() ? 'yarn' : 'npm';
  return (0, _run.default)(command, commandArgs, {
    stdio
  });
}
/**
 *
 * @param {string} packageName Npm package name
 * @returns Package info equal to: npm info @layer0/cli --json
 */


function getNodePackageInfo(packageName) {
  return runNodePackageManagerScript(['info', packageName, '--json']);
}
/**
 * Installs packages if they are not already installed.
 * @param {Object} libs The libs to install.  Keys are the names of node packages and values are versions
 * @param {Object} options
 * @param {Object} options.dev If true, the libs will be installed as devDependencies.
 * @param {Object} options.skipLayer0Deps If true, @layer0 libs will not be installed. Useful for yalc-ing during development
 * @return {Promise}
 */


async function installDependencies(libs, {
  dev = false,
  skipLayer0Deps = false
} = {}) {
  const toInstall = [],
        packageNames = [],
        commandArgs = [];

  for (let lib in libs) {
    if (skipLayer0Deps && lib.startsWith('@layer0')) {
      continue;
    }

    packageNames.push(lib);
    toInstall.push(`${lib}@${libs[lib]}`);
  }

  if (toInstall.length === 0) return Promise.resolve();
  const message = `installing ${_chalk.default.green(packageNames.join(', '))}...`;
  const spinner = (0, _ora.default)(message).start();

  if (isYarn()) {
    commandArgs.push('add');
    commandArgs.push('--ignore-workspace-root-check');
    dev && commandArgs.push('--dev');
  } else {
    commandArgs.push('install');
    commandArgs.push(dev ? '--save-dev' : '--save');
  }

  try {
    await runNodePackageManagerScript([...commandArgs, ...toInstall]);
    spinner.succeed(`${message} done.`);
    return Promise.resolve();
  } catch (e) {
    spinner.fail(`${message} failed.\n`);
    return Promise.reject(e);
  }
}